---
- name: Configure Keyboard
  hosts: 127.0.0.1
  connection: local
  gather_facts: no
  tasks:
    - action: copy
      name: Backup files
      args:
        backup: yes
        src: "{{item}}"
        dest: "{{item}}.bak"
      with_items:
        - /usr/share/X11/xkb/rules/evdev.lst
        - /usr/share/X11/xkb/rules/evdev.xml
    - action: copy
      name: Copy keyboard layout file
      args:
        src: files/usr/share/X11/xkb/symbols/custom
        dest: /usr/share/X11/xkb/symbols/custom
        backup: yes
    - action: lineinfile
      name: Set default keyboard layout
      args:
        dest: /etc/default/keyboard
        regexp: ^XKBLAYOUT
        line: XKBLAYOUT="custom"
    - action: lineinfile
      name: Set default keyboard layout variant
      args:
        dest: /etc/default/keyboard
        regexp: ^XKBVARIANT
        line: XKBVARIANT="us-sv-dvorak"
    - action: lineinfile
      name: Set default keyboard layout options
      args:
        dest: /etc/default/keyboard
        regexp: ^XKBOPTIONS
        line: XKBOPTIONS="caps:ctrl_modifier"
    - shell: dpkg-reconfigure keyboard-configuration -p high
      name: Set default layout
    - shell: setxkbmap -layout custom -option 'caps:ctrl_modifier'
      name: Set current layout
    - script: scripts/add-evdev-xml /usr/share/X11/xkb/rules/evdev.xml
      name: Add xkb rules to evdev.xml
    - script: scripts/add-evdev-lst /usr/share/X11/xkb/rules/evdev.lst
      name: Add xkb rules to evdev.lst
